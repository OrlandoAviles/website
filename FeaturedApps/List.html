<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lists</title>

  <style>
    :root {
      --bg1: #2c3e50;
      --bg2: #4ca1af;
      --panel: rgba(0, 0, 0, 0.25);
      --panel-strong: rgba(0, 0, 0, 0.88);
      --item: rgba(255, 255, 255, 0.10);
      --item-hover: rgba(255, 255, 255, 0.18);
      --accent: #3498db;
      --accent-hover: #2980b9;
      --danger: #ff6b6b;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: sans-serif;
      background: linear-gradient(135deg, var(--bg1), var(--bg2));
      color: white;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .app {
      width: min(720px, 100%);
      background: var(--panel);
      border-radius: 16px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.30);
      position: relative;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .title-wrap {
      flex: 1;
      min-width: 0;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      width: fit-content;
      max-width: 100%;
    }

    #listTitleBtn {
      all: unset;
      cursor: pointer;
      display: inline-block;
      max-width: 100%;
    }

    #listTitle {
      margin: 0;
      font-size: 28px;
      line-height: 1.1;
      letter-spacing: 0.2px;
      user-select: none;
      overflow-wrap: anywhere;
    }

    .edit-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.10);
      opacity: 0;
      transform: translateY(2px) scale(0.98);
      transition: opacity 0.18s ease, transform 0.18s ease, background 0.18s ease;
      padding: 0;
      font-size: 16px;
    }

    .title-row:hover .edit-icon,
    .title-row:focus-within .edit-icon {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .edit-icon:hover { background: rgba(255,255,255,0.18); }

    #titleHint {
      font-size: 12px;
      opacity: 0.75;
      margin-top: 5px;
      user-select: none;
    }

    #listTitleInput {
      display: none;
      width: min(420px, 100%);
      font-size: 22px;
      font-weight: 800;
      padding: 8px 10px;
      border: none;
      border-radius: 12px;
      outline: none;
      margin-top: 4px;
      transform-origin: left center;
    }

    .pop-in { animation: popIn 180ms ease-out; }
    @keyframes popIn {
      from { opacity: 0; transform: scale(0.98) translateY(-2px); }
      to   { opacity: 1; transform: scale(1) translateY(0); }
    }

    .input-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: none;
      border-radius: 10px;
      outline: none;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 10px;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover { background: var(--accent-hover); }

    ul {
      list-style: none;
      padding: 0;
      margin: 14px 0 0;
    }

    /* Item row */
    li {
      margin: 8px 0;
      padding: 10px 12px;
      background: var(--item);
      border-radius: 12px;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    li:hover { background: var(--item-hover); }

    .check {
      width: 20px;
      height: 20px;
      cursor: pointer;
      flex: 0 0 auto;
    }

    .item-text {
      flex: 1;
      overflow-wrap: anywhere;
      user-select: none;
      cursor: pointer;
    }

    li.completed .item-text {
      opacity: 0.7;
      text-decoration: line-through;
    }

    .delete-item {
      background: rgba(255,255,255,0.10);
      border: none;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      cursor: pointer;
      flex: 0 0 auto;
      padding: 0;
      font-size: 16px;
      color: white;
    }

    .delete-item:hover {
      background: rgba(255, 107, 107, 0.16);
    }

    #listMenuBtn {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      font-size: 22px;
      padding: 0;
      display: grid;
      place-items: center;
      flex: 0 0 auto;
    }

    #listMenu {
      position: absolute;
      top: 66px;
      right: 18px;
      width: 260px;
      background: var(--panel-strong);
      border-radius: 14px;
      padding: 12px;
      display: none;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      z-index: 1000;
    }

    .menu-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #newListName { flex: 1; }
    #savedLists { margin-top: 10px; }

    #savedLists li {
      background: transparent;
      padding: 8px 6px;
      margin: 0;
      border-radius: 10px;
    }

    #savedLists li:hover { background: rgba(255,255,255,0.08); }

    .list-name { flex: 1; cursor: pointer; user-select: none; }

    .delete-list {
      background: transparent;
      border: none;
      color: var(--danger);
      font-size: 18px;
      cursor: pointer;
      padding: 0 8px;
      border-radius: 10px;
    }

    .delete-list:hover { background: rgba(255, 107, 107, 0.12); }

    /* Undo toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.86);
      padding: 12px 14px;
      border-radius: 14px;
      display: none;
      gap: 12px;
      align-items: center;
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
      z-index: 2000;
      max-width: min(520px, 92vw);
    }

    #toastText {
      font-size: 14px;
      opacity: 0.95;
      user-select: none;
      overflow-wrap: anywhere;
    }

    #undoBtn {
      background: rgba(255,255,255,0.12);
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 800;
    }

    #undoBtn:hover { background: rgba(255,255,255,0.20); }

    @media (max-width: 480px) {
      #listTitle { font-size: 24px; }
      #listMenu { width: min(280px, 92vw); }
      .input-row { flex-direction: column; }
      .input-row button { width: 100%; }
      #titleHint { display: none; }
      .edit-icon { opacity: 1; }
    }
  </style>
</head>

<body>
  <div class="app">

    <div class="header">
      <div class="title-wrap">

        <div class="title-row">
          <button id="listTitleBtn" aria-label="Rename current list">
            <h1 id="listTitle">Default</h1>
          </button>

          <button class="edit-icon" id="editTitleBtn" aria-label="Edit list name" title="Rename">
            ✏️
          </button>
        </div>

        <div id="titleHint">Tap title to rename</div>

        <input id="listTitleInput" type="text" autocomplete="off" />

      </div>

      <button id="listMenuBtn" aria-label="Lists menu">☰</button>
    </div>

    <div class="input-row">
      <input type="text" id="listItemInput" placeholder="Add a new item..." />
      <button id="addItemBtn">Add Item</button>
    </div>

    <ul id="list"></ul>

    <div id="listMenu">
      <div class="menu-row">
        <input type="text" id="newListName" placeholder="New list name..." />
        <button id="createListBtn">Create</button>
      </div>
      <ul id="savedLists"></ul>
    </div>

  </div>

  <div id="toast" role="status" aria-live="polite">
    <div id="toastText">Item deleted</div>
    <button id="undoBtn" type="button">Undo</button>
  </div>

  <script>
    let currentList = localStorage.getItem('currentList') || 'Default';

    function getLists() {
      return JSON.parse(localStorage.getItem('lists') || '{}');
    }

    function saveLists(lists) {
      localStorage.setItem('lists', JSON.stringify(lists));
    }

    function normalizeName(name) {
      return name.trim().replace(/\s+/g, ' ');
    }

    /* ------------------------
       Migration: old string items -> object items
       Old: ["Milk", "Eggs"]
       New: [{ text:"Milk", done:false }, ...]
    ------------------------ */
    function ensureItemObjects(lists) {
      let changed = false;
      for (const listName of Object.keys(lists)) {
        const arr = lists[listName];
        if (!Array.isArray(arr)) {
          lists[listName] = [];
          changed = true;
          continue;
        }
        if (arr.length > 0 && typeof arr[0] === 'string') {
          lists[listName] = arr.map(t => ({ text: t, done: false }));
          changed = true;
        }
      }
      if (changed) saveLists(lists);
      return lists;
    }

    /* ------------------------
       Undo System (for deletes)
    ------------------------ */
    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    const undoBtn = document.getElementById('undoBtn');

    let undoState = null;  // { listName, index, value }
    let toastTimer = null;

    function showToast(message, undoPayload) {
      toastText.textContent = message;
      toast.style.display = 'flex';
      undoState = undoPayload;

      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => hideToast(), 5200);
    }

    function hideToast() {
      toast.style.display = 'none';
      undoState = null;
      clearTimeout(toastTimer);
      toastTimer = null;
    }

    function performUndo() {
      if (!undoState) return;

      const lists = ensureItemObjects(getLists());
      const { listName, index, value } = undoState;

      lists[listName] = lists[listName] || [];
      const safeIndex = Math.max(0, Math.min(index, lists[listName].length));
      lists[listName].splice(safeIndex, 0, value);

      saveLists(lists);
      hideToast();
      loadList();
    }

    undoBtn.addEventListener('click', performUndo);

    document.addEventListener('keydown', (e) => {
      const key = e.key.toLowerCase();
      if ((e.ctrlKey || e.metaKey) && key === 'z') {
        if (undoState) {
          e.preventDefault();
          performUndo();
        }
      }
    });

    /* ------------------------
       Core Renderer
    ------------------------ */
    function loadList() {
      const ul = document.getElementById('list');
      ul.innerHTML = '';

      const lists = ensureItemObjects(getLists());
      const items = (lists[currentList] || []).slice();

      // ✅ Completed items move to bottom
      items.sort((a, b) => Number(a.done) - Number(b.done));

      items.forEach((item, renderIndex) => {
        const li = document.createElement('li');
        if (item.done) li.classList.add('completed');

        // Checkbox
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'check';
        cb.checked = !!item.done;
        cb.addEventListener('click', (e) => e.stopPropagation());
        cb.addEventListener('change', () => toggleDoneByIdentity(item));

        // Text
        const span = document.createElement('span');
        span.className = 'item-text';
        span.textContent = item.text;
        span.addEventListener('click', () => {
          cb.checked = !cb.checked;
          cb.dispatchEvent(new Event('change'));
        });

        // Delete button
        const del = document.createElement('button');
        del.className = 'delete-item';
        del.type = 'button';
        del.title = 'Delete item';
        del.textContent = '✕';
        del.addEventListener('click', (e) => {
          e.stopPropagation();
          deleteItemByIdentity(item);
        });

        li.appendChild(cb);
        li.appendChild(span);
        li.appendChild(del);
        ul.appendChild(li);
      });

      document.getElementById('listTitle').textContent = currentList;
      loadSavedLists();
    }

    /* ------------------------
       Identity helpers (no IDs yet)
       We'll match by text+done+first occurrence.
    ------------------------ */
    function findItemIndex(listArr, target) {
      return listArr.findIndex(it => it.text === target.text && it.done === target.done);
    }

    function toggleDoneByIdentity(target) {
      const lists = ensureItemObjects(getLists());
      const arr = lists[currentList] || [];

      const idx = findItemIndex(arr, target);
      if (idx === -1) return;

      arr[idx].done = !arr[idx].done;
      saveLists(lists);
      loadList();
    }

    function deleteItemByIdentity(target) {
      const lists = ensureItemObjects(getLists());
      const arr = lists[currentList] || [];

      const idx = findItemIndex(arr, target);
      if (idx === -1) return;

      const removed = arr.splice(idx, 1)[0];
      saveLists(lists);

      showToast('Item deleted', {
        listName: currentList,
        index: idx,
        value: removed
      });

      loadList();
    }

    /* ------------------------
       Item Actions
    ------------------------ */
    function addListItem() {
      const input = document.getElementById('listItemInput');
      const text = input.value.trim();
      if (!text) return;

      const lists = ensureItemObjects(getLists());
      lists[currentList] = lists[currentList] || [];
      lists[currentList].push({ text, done: false });
      saveLists(lists);

      input.value = '';
      loadList();
    }

    /* ------------------------
       List Actions
    ------------------------ */
    function createNewList() {
      const input = document.getElementById('newListName');
      const name = normalizeName(input.value);
      if (!name) return;

      const lists = ensureItemObjects(getLists());
      if (!lists[name]) lists[name] = [];

      saveLists(lists);
      switchList(name);
      input.value = '';
    }

    function switchList(name) {
      currentList = name;
      localStorage.setItem('currentList', name);
      loadList();
    }

    function deleteList(name) {
      const lists = ensureItemObjects(getLists());
      delete lists[name];
      saveLists(lists);

      if (currentList === name) {
        const remaining = Object.keys(lists);
        currentList = remaining[0] || 'Default';
        localStorage.setItem('currentList', currentList);
      }

      loadList();
    }

    function loadSavedLists() {
      const ul = document.getElementById('savedLists');
      ul.innerHTML = '';

      const lists = ensureItemObjects(getLists());

      Object.keys(lists).forEach(name => {
        const li = document.createElement('li');

        const span = document.createElement('span');
        span.textContent = name;
        span.className = 'list-name';
        span.onclick = () => switchList(name);

        const del = document.createElement('button');
        del.textContent = '✕';
        del.className = 'delete-list';
        del.onclick = (e) => {
          e.stopPropagation();
          deleteList(name);
        };

        li.appendChild(span);
        li.appendChild(del);
        ul.appendChild(li);
      });
    }

    /* ------------------------
       Rename Title
    ------------------------ */
    const titleBtn = document.getElementById('listTitleBtn');
    const editTitleBtn = document.getElementById('editTitleBtn');
    const titleInput = document.getElementById('listTitleInput');
    const titleHint = document.getElementById('titleHint');

    let renaming = false;
    let renameOldName = '';

    function startRename() {
      renaming = true;
      renameOldName = currentList;

      titleBtn.style.display = 'none';
      editTitleBtn.style.display = 'none';
      titleHint.style.display = 'none';

      titleInput.style.display = 'block';
      titleInput.classList.remove('pop-in');
      void titleInput.offsetWidth;
      titleInput.classList.add('pop-in');

      titleInput.value = currentList;
      titleInput.focus();
      titleInput.select();
    }

    function cancelRename() {
      renaming = false;
      titleInput.style.display = 'none';
      titleBtn.style.display = 'inline-block';
      editTitleBtn.style.display = 'grid';
      titleHint.style.display = 'block';
      titleInput.value = '';
    }

    function commitRename() {
      const newName = normalizeName(titleInput.value);

      if (!newName) { cancelRename(); return; }
      if (newName === renameOldName) { cancelRename(); return; }

      const lists = ensureItemObjects(getLists());

      if (Object.prototype.hasOwnProperty.call(lists, newName)) {
        alert('A list with that name already exists.');
        titleInput.focus();
        titleInput.select();
        return;
      }

      lists[newName] = lists[renameOldName] || [];
      delete lists[renameOldName];
      saveLists(lists);

      currentList = newName;
      localStorage.setItem('currentList', currentList);

      cancelRename();
      loadList();
    }

    titleBtn.addEventListener('click', startRename);
    editTitleBtn.addEventListener('click', startRename);

    titleInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') commitRename();
      if (e.key === 'Escape') cancelRename();
    });

    titleInput.addEventListener('blur', () => {
      if (renaming) commitRename();
    });

    /* ------------------------
       Menu Toggle
    ------------------------ */
    const menuBtn = document.getElementById('listMenuBtn');
    const menu = document.getElementById('listMenu');

    menuBtn.onclick = (e) => {
      e.stopPropagation();
      const isHidden = getComputedStyle(menu).display === 'none';
      menu.style.display = isHidden ? 'block' : 'none';
    };

    document.addEventListener('click', (e) => {
      if (menu.style.display === 'block') {
        const clickedInside = menu.contains(e.target) || menuBtn.contains(e.target);
        if (!clickedInside) menu.style.display = 'none';
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') menu.style.display = 'none';
    });

    /* ------------------------
       Buttons + Enter key
    ------------------------ */
    document.getElementById('addItemBtn').addEventListener('click', addListItem);
    document.getElementById('createListBtn').addEventListener('click', createNewList);

    document.getElementById('listItemInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addListItem();
    });

    document.getElementById('newListName').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') createNewList();
    });

    /* ------------------------
       Startup
    ------------------------ */
    loadList();
  </script>
</body>
</html>
