<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blackjack (Vanilla JS)</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1410;
      --panel: #0f1f18;
      --card: #13261e;
      --text: #e9f3ee;
      --muted: #b8c7bf;
      --accent: #62d6a7;
      --danger: #ff6b6b;
      --shadow: rgba(0,0,0,.35);
      --radius: 16px;
      --gap: 12px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 30% 10%, #103322 0%, var(--bg) 55%);
      color: var(--text);
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 20px;
    }
    .app {
      width: min(920px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: 0 16px 40px var(--shadow);
      overflow: hidden;
    }
    header {
      padding: 18px 18px 10px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: var(--gap);
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: .4px;
    }
    header .sub {
      color: var(--muted);
      font-size: 13px;
      margin-left: 8px;
    }
    .topline {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
      color: var(--muted);
      font-size: 13px;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
    }
    main {
      padding: 18px;
      display: grid;
      gap: 16px;
    }
    .table {
      display: grid;
      gap: 16px;
    }
    .row {
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 14px;
      display: grid;
      gap: 10px;
    }
    .row h2 {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .hand {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      min-height: 54px;
    }
    .card {
      width: 72px;
      height: 96px;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.1));
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      display: grid;
      place-items: center;
      padding: 8px;
      position: relative;
      user-select: none;
    }
    .card .big {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: .3px;
    }
    .card .small {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 12px;
      color: rgba(233,243,238,.85);
    }
    .card.red { color: #ffb3b3; }
    .card.black { color: #d7e6df; }
    .card.back {
      background: repeating-linear-gradient(
        45deg,
        rgba(98,214,167,.22),
        rgba(98,214,167,.22) 8px,
        rgba(0,0,0,.12) 8px,
        rgba(0,0,0,.12) 16px
      );
    }
    .scoreline {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 13px;
    }
    .scoreline strong {
      color: var(--text);
      font-weight: 700;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      background: rgba(0,0,0,.16);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      padding: 12px;
    }
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; }
    button {
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 650;
      letter-spacing: .2px;
      cursor: pointer;
      transition: transform .06s ease, background .15s ease, opacity .15s ease;
    }
    button:hover { background: rgba(255,255,255,.10); }
    button:active { transform: translateY(1px); }
    button.primary {
      border-color: rgba(98,214,167,.35);
      background: rgba(98,214,167,.18);
    }
    button.danger {
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.16);
    }
    button:disabled {
      opacity: .45;
      cursor: not-allowed;
    }
    .status {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 52ch;
    }
    .status b { color: var(--text); }
    footer {
      padding: 14px 18px 18px;
      color: rgba(233,243,238,.55);
      font-size: 12px;
    }
    kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(233,243,238,.85);
    }
    .bet-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .bet-controls input {
      width: 90px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.2);
      background: rgba(0,0,0,.25);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Blackjack">
    <header>
      <div>
        <h1>Blackjack <span class="sub">Vanilla JS</span></h1>
      </div>
      <div class="topline">
        <div class="pill">Bankroll: <strong id="bankroll">500</strong> chips</div>
        <div class="pill">Current Bet: <strong id="currentBet">0</strong></div>
        <div class="pill">
          Shortcuts:
          <kbd>P</kbd> Place Bet • <kbd>H</kbd> Hit • <kbd>S</kbd> Stand • <kbd>D</kbd> Double
        </div>
        <div class="pill">Wins: <span id="wins">0</span> • Losses: <span id="losses">0</span> • Pushes: <span id="pushes">0</span></div>
      </div>
    </header>

    <main>
      <section class="table">
        <div class="row">
          <h2>Dealer</h2>
          <div class="hand" id="dealerHand" aria-label="Dealer hand"></div>
          <div class="scoreline">
            <span>Score:</span>
            <strong id="dealerScore">?</strong>
            <span id="dealerHint"></span>
          </div>
        </div>

        <div class="row">
          <h2>You</h2>
          <div class="hand" id="playerHand" aria-label="Player hand"></div>
          <div class="scoreline">
            <span>Score:</span>
            <strong id="playerScore">0</strong>
            <span id="playerHint"></span>
          </div>
        </div>
      </section>

      <section class="controls">
        <div class="bet-controls">
          <label for="betInput">Bet:</label>
          <input id="betInput" type="number" min="1" step="1" value="25" />
          <button id="btnPlaceBet" class="primary">Place Bet & Deal</button>
        </div>
        <div class="buttons">
          <button id="btnHit">Hit</button>
          <button id="btnStand">Stand</button>
          <button id="btnDouble" class="primary">Double Down</button>
          <button id="btnReveal" class="danger">Reveal / Settle</button>
        </div>
        <div class="status" id="status">Place a bet to start a hand.</div>
      </section>
    </main>

    <footer>
      Blackjack pays 3:2. Dealer draws to 17 and stands on soft 17.
    </footer>
  </div>

  <script>
    // ---------- Blackjack ----------
    const SUITS = [
      { s: "♠", color: "black" },
      { s: "♥", color: "red" },
      { s: "♦", color: "red" },
      { s: "♣", color: "black" },
    ];
    const RANKS = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

    function makeDeck() {
      const deck = [];
      for (const suit of SUITS) {
        for (const rank of RANKS) {
          deck.push({ rank, suit: suit.s, color: suit.color });
        }
      }
      return deck;
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function cardValue(rank) {
      if (rank === "A") return 11;
      if (["K","Q","J"].includes(rank)) return 10;
      return Number(rank);
    }

    function handTotals(hand) {
      // Returns best total <= 21 if possible, else the lowest total.
      // isSoft = at least one Ace is still being counted as 11.
      let total = 0;
      let aces = 0;

      for (const c of hand) {
        total += cardValue(c.rank);
        if (c.rank === "A") aces++;
      }

      // Convert A(11) -> A(1) by subtracting 10 as needed.
      // Each subtraction represents one Ace no longer counted as 11.
      while (total > 21 && aces > 0) {
        total -= 10;
        aces--;
      }

      const isSoft = total <= 21 && aces > 0;
      return { total, isSoft };
    }

    // ---------- State ----------
    let deck = shuffle(makeDeck());
    let player = [];
    let dealer = [];
    let hiddenDealer = true;
    let roundOver = true;

    let bankroll = 500;
    let currentBet = 0;

    const stats = { wins: 0, losses: 0, pushes: 0 };

    // ---------- DOM ----------
    const elDealerHand = document.getElementById("dealerHand");
    const elPlayerHand = document.getElementById("playerHand");
    const elDealerScore = document.getElementById("dealerScore");
    const elPlayerScore = document.getElementById("playerScore");
    const elDealerHint = document.getElementById("dealerHint");
    const elPlayerHint = document.getElementById("playerHint");
    const elStatus = document.getElementById("status");

    const elWins = document.getElementById("wins");
    const elLosses = document.getElementById("losses");
    const elPushes = document.getElementById("pushes");

    const elBankroll = document.getElementById("bankroll");
    const elCurrentBet = document.getElementById("currentBet");
    const betInput = document.getElementById("betInput");

    const btnPlaceBet = document.getElementById("btnPlaceBet");
    const btnHit = document.getElementById("btnHit");
    const btnStand = document.getElementById("btnStand");
    const btnDouble = document.getElementById("btnDouble");
    const btnReveal = document.getElementById("btnReveal");

    function setStatus(html) {
      elStatus.innerHTML = html;
    }

    function updateBankrollDisplay() {
      elBankroll.textContent = bankroll;
      elCurrentBet.textContent = currentBet;
    }

    function ensureDeck() {
      // infinite shoe feel: reshuffle when low
      if (deck.length < 15) deck = shuffle(makeDeck());
    }

    function draw() {
      ensureDeck();
      return deck.pop();
    }

    function renderCard(c, faceDown=false) {
      const div = document.createElement("div");
      if (faceDown) {
        div.className = "card back";
        div.title = "Face down";
        return div;
      }
      div.className = `card ${c.color}`;
      const small = document.createElement("div");
      small.className = "small";
      small.textContent = `${c.rank}${c.suit}`;
      const big = document.createElement("div");
      big.className = "big";
      big.textContent = c.suit;
      div.appendChild(small);
      div.appendChild(big);
      div.title = `${c.rank}${c.suit}`;
      return div;
    }

    function renderHands() {
      elDealerHand.innerHTML = "";
      elPlayerHand.innerHTML = "";

      dealer.forEach((c, idx) => {
        const faceDown = hiddenDealer && idx === 0;
        elDealerHand.appendChild(renderCard(c, faceDown));
      });

      player.forEach(c => elPlayerHand.appendChild(renderCard(c)));

      const p = handTotals(player);
      elPlayerScore.textContent = p.total;
      elPlayerHint.textContent = p.isSoft ? " (soft)" : "";

      if (hiddenDealer) {
        if (dealer.length > 1) {
          const up = handTotals([dealer[1]]);
          elDealerScore.textContent = `${up.total} + ?`;
        } else {
          elDealerScore.textContent = "?";
        }
        elDealerHint.textContent = "";
      } else {
        const d = handTotals(dealer);
        elDealerScore.textContent = d.total;
        elDealerHint.textContent = d.isSoft ? " (soft)" : "";
      }
    }

    function setButtons() {
      btnHit.disabled = roundOver;
      btnStand.disabled = roundOver;
      btnReveal.disabled = roundOver;
      btnDouble.disabled = roundOver || player.length !== 2;
      btnPlaceBet.disabled = !roundOver;
    }

    function resetRound() {
      player = [];
      dealer = [];
      hiddenDealer = true;
      roundOver = false;
      setButtons();
    }

    function startRoundWithBet() {
      const bet = Number(betInput.value);
      if (!Number.isFinite(bet) || bet <= 0 || bet > bankroll) {
        setStatus("Invalid bet amount.");
        return;
      }

      currentBet = bet;
      bankroll -= bet;
      updateBankrollDisplay();

      resetRound();

      // Initial deal
      dealer.push(draw(), draw());
      player.push(draw(), draw());

      renderHands();
      setButtons(); // enables Double Down while player has exactly 2 cards

      const p = handTotals(player).total;
      const d = handTotals(dealer).total;

      // Natural check
      if (p === 21 || d === 21) {
        hiddenDealer = false;
        renderHands();
        settle(true);
        return;
      }

      setStatus("Your move: <b>Hit</b>, <b>Stand</b>, or <b>Double Down</b>.");
    }

    function playerHit() {
      if (roundOver) return;

      player.push(draw());
      renderHands();
      setButtons();

      const p = handTotals(player).total;
      if (p > 21) {
        hiddenDealer = false;
        renderHands();
        settle(false);
      } else if (p === 21) {
        setStatus("You hit <b>21</b>. Dealer will play out.");
        dealerPlayAndSettle();
      } else {
        setStatus("You drew a card. Still your move.");
      }
    }

    function playerStand() {
      if (roundOver) return;
      setStatus("You stand. Dealer's turn.");
      dealerPlayAndSettle();
    }

    function playerDoubleDown() {
      if (roundOver) return;
      if (player.length !== 2) return;

      // must match current bet
      if (bankroll < currentBet) {
        setStatus("Not enough chips to double down.");
        return;
      }

      bankroll -= currentBet;
      currentBet *= 2;
      updateBankrollDisplay();

      player.push(draw());
      renderHands();
      setButtons();

      setStatus("Double down! One card only.");
      dealerPlayAndSettle();
    }

    function dealerPlayAndSettle() {
      hiddenDealer = false;
      renderHands();

      // Dealer hits to 17; stands on soft 17.
      while (handTotals(dealer).total < 17) {
        dealer.push(draw());
        renderHands();
      }

      settle(false);
    }

    function settle(fromNatural=false) {
      hiddenDealer = false;
      renderHands();

      const p = handTotals(player).total;
      const d = handTotals(dealer).total;

      roundOver = true;
      setButtons();

      let result = "";

      if (p > 21) {
        stats.losses++;
        result = "You busted. <b>Dealer wins</b>.";
      } else if (d > 21) {
        stats.wins++;
        bankroll += currentBet * 2;
        result = "Dealer busted. <b>You win</b>.";
      } else if (p > d) {
        stats.wins++;
        if (fromNatural && p === 21 && player.length === 2) {
          // blackjack: 3:2. total return to player is 2.5x of original bet.
          bankroll += Math.floor(currentBet * 2.5);
          result = "<b>Blackjack!</b> Paid 3:2.";
        } else {
          bankroll += currentBet * 2;
          result = "<b>You win</b>.";
        }
      } else if (p < d) {
        stats.losses++;
        result = "Dealer wins.";
      } else {
        stats.pushes++;
        bankroll += currentBet;
        result = "<b>Push</b> (tie).";
      }

      currentBet = 0;
      updateBankrollDisplay();

      elWins.textContent = stats.wins;
      elLosses.textContent = stats.losses;
      elPushes.textContent = stats.pushes;

      setStatus(`${result} Place another bet to continue.`);
    }

    function revealAndSettle() {
      if (roundOver) return;
      setStatus("Revealing and settling…");
      dealerPlayAndSettle();
    }

    // ---------- Events ----------
    btnPlaceBet.addEventListener("click", startRoundWithBet);
    btnHit.addEventListener("click", playerHit);
    btnStand.addEventListener("click", playerStand);
    btnDouble.addEventListener("click", playerDoubleDown);
    btnReveal.addEventListener("click", revealAndSettle);

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (k === "p") startRoundWithBet();
      if (k === "h") playerHit();
      if (k === "s") playerStand();
      if (k === "d") playerDoubleDown();
    });

    // ---------- Self-tests (console) ----------
    // No framework. These run once on load and log results.
    function assert(name, condition) {
      if (!condition) {
        console.error(`❌ Test failed: ${name}`);
        return false;
      }
      console.log(`✅ ${name}`);
      return true;
    }

    function runSelfTests() {
      // handTotals tests
      assert("handTotals: A + 9 = 20 (soft)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"9",suit:"♣",color:"black"}];
        const t = handTotals(h);
        return t.total === 20 && t.isSoft === true;
      })());

      assert("handTotals: A + A + 9 = 21 (soft)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"A",suit:"♥",color:"red"},{rank:"9",suit:"♣",color:"black"}];
        const t = handTotals(h);
        return t.total === 21 && t.isSoft === true;
      })());

      assert("handTotals: A + A + 9 + 9 = 20 (hard)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"A",suit:"♥",color:"red"},{rank:"9",suit:"♣",color:"black"},{rank:"9",suit:"♦",color:"red"}];
        const t = handTotals(h);
        return t.total === 20 && t.isSoft === false;
      })());

      // Added: more Ace edge cases
      assert("handTotals: A + K = 21 (soft)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"K",suit:"♣",color:"black"}];
        const t = handTotals(h);
        return t.total === 21 && t.isSoft === true;
      })());

      assert("handTotals: A + 9 + 9 = 19 (hard)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"9",suit:"♣",color:"black"},{rank:"9",suit:"♦",color:"red"}];
        const t = handTotals(h);
        return t.total === 19 && t.isSoft === false;
      })());

      assert("handTotals: A + A + 8 = 20 (soft)", (() => {
        const h = [{rank:"A",suit:"♠",color:"black"},{rank:"A",suit:"♥",color:"red"},{rank:"8",suit:"♦",color:"red"}];
        const t = handTotals(h);
        return t.total === 20 && t.isSoft === true;
      })());

      // payout sanity tests (simulate settle outcomes)
      const snapshot = {
        deck, player, dealer, hiddenDealer, roundOver, bankroll, currentBet,
        stats: { ...stats },
        ui: {
          wins: elWins.textContent,
          losses: elLosses.textContent,
          pushes: elPushes.textContent,
          status: elStatus.innerHTML,
        }
      };

      // force a deterministic win (non-blackjack): bet 10, bankroll 100 -> should end at 120
      bankroll = 100;
      currentBet = 10;
      player = [{rank:"10",suit:"♠",color:"black"},{rank:"9",suit:"♣",color:"black"}]; // 19
      dealer = [{rank:"10",suit:"♥",color:"red"},{rank:"8",suit:"♦",color:"red"}]; // 18
      hiddenDealer = false;
      roundOver = false;
      settle(false);
      assert("payout: normal win pays 1:1", bankroll === 120); // +20 (return 2x bet)

      // restore snapshot (so UI/game starts clean)
      deck = snapshot.deck;
      player = snapshot.player;
      dealer = snapshot.dealer;
      hiddenDealer = snapshot.hiddenDealer;
      roundOver = snapshot.roundOver;
      bankroll = snapshot.bankroll;
      currentBet = snapshot.currentBet;
      stats.wins = snapshot.stats.wins;
      stats.losses = snapshot.stats.losses;
      stats.pushes = snapshot.stats.pushes;

      elWins.textContent = snapshot.ui.wins;
      elLosses.textContent = snapshot.ui.losses;
      elPushes.textContent = snapshot.ui.pushes;
      elStatus.innerHTML = snapshot.ui.status;

      updateBankrollDisplay();
      renderHands();
      setButtons();
    }

    // Boot
    updateBankrollDisplay();
    renderHands();
    setButtons();
    setStatus('Place a bet to start a hand.');

    runSelfTests();
  </script>
</body>
</html>
